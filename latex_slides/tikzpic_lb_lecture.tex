% Requires in preamble:
% \usetikzlibrary{arrows.meta,fit,positioning}

\begin{tikzpicture}[
  >=Latex,
  font=\small,
  state/.style={circle,draw,minimum size=9mm,inner sep=1pt},
  obsbox/.style={draw,densely dotted,rounded corners,inner sep=3.0mm},
  aone/.style={thick},
  atwo/.style={thick,dashed}
]

% -------------------------
% Geometry (as before)
% -------------------------
\def\xOne{0}
\def\xTwo{2.1}
\def\xThree{4.2}
\def\xDots{6.2}
\def\xLast{8.4}
\def\xAgg{11.2}

\def\yRowZero{0}
\def\yRowOne{-2.0}
\def\yRowMid{-4.2}
\def\yRowHm{-6.4}
\def\yRowH{-8.4}

% How much extra room to the LEFT for the D_h boxes
\def\boxLeftExtra{2.1cm}

% Shift the whole picture right to create left margin
\begin{scope}[xshift=1.6cm]

% -------------------------
% Nodes
% -------------------------
\node[state] (s0-1) at (\xOne,\yRowZero) {$s_0^{1}$};
\node[state] (s0-2) at (\xTwo,\yRowZero) {$s_0^{2}$};
\node[state] (s0-3) at (\xThree,\yRowZero) {$s_0^{3}$};
\node        (s0-d) at (\xDots,\yRowZero) {$\cdots$};
\node[state] (s0-m) at (\xLast,\yRowZero) {$s_0^{m}$};
\node[state] (g0)   at (\xAgg,\yRowZero) {$g_0$};

\node[state] (s1-1) at (\xOne,\yRowOne) {$s_1^{1}$};
\node[state] (s1-2) at (\xTwo,\yRowOne) {$s_1^{2}$};
\node[state] (s1-3) at (\xThree,\yRowOne) {$s_1^{3}$};
\node        (s1-d) at (\xDots,\yRowOne) {$\cdots$};
\node[state] (s1-m) at (\xLast,\yRowOne) {$s_1^{m}$};
\node[state] (g1)   at (\xAgg,\yRowOne) {$g_1$};

\node[state] (sh-1) at (\xOne,\yRowMid) {$s_h^{1}$};
\node[state] (sh-2) at (\xTwo,\yRowMid) {$s_h^{2}$};
\node[state] (sh-3) at (\xThree,\yRowMid) {$s_h^{3}$};
\node        (sh-d) at (\xDots,\yRowMid) {$\cdots$};
\node[state] (sh-m) at (\xLast,\yRowMid) {$s_h^{m}$};
\node[state] (gh)   at (\xAgg,\yRowMid) {$g_h$};

\node[state] (sHm-1) at (\xOne,\yRowHm) {$s_{H-2}^{1}$};
\node[state] (sHm-2) at (\xTwo,\yRowHm) {$s_{H-2}^{2}$};
\node[state] (sHm-3) at (\xThree,\yRowHm) {$s_{H-2}^{3}$};
\node        (sHm-d) at (\xDots,\yRowHm) {$\cdots$};
\node[state] (sHm-m) at (\xLast,\yRowHm) {$s_{H-2}^{m}$};
\node[state] (gHm)   at (\xAgg,\yRowHm) {$g_{H-2}$};

\node[state] (sH-1) at (\xOne,\yRowH) {$s_{H-1}^{1}$};
\node[state] (sH-2) at (\xTwo,\yRowH) {$s_{H-1}^{2}$};
\node[state] (sH-3) at (\xThree,\yRowH) {$s_{H-1}^{3}$};
\node        (sH-d) at (\xDots,\yRowH) {$\cdots$};
\node[state] (sH-m) at (\xLast,\yRowH) {$s_{H-1}^{m}$};
\node[state] (gH)   at (\xAgg,\yRowH) {$g_{H-1}$};

% -------------------------
% Data support boxes: extend LEFT to create writing room
% -------------------------
\coordinate (L0)  at ([xshift=-\boxLeftExtra]s0-1.west);
\coordinate (L1)  at ([xshift=-\boxLeftExtra]s1-1.west);
\coordinate (Lh)  at ([xshift=-\boxLeftExtra]sh-1.west);
\coordinate (LHm) at ([xshift=-\boxLeftExtra]sHm-1.west);
\coordinate (LH)  at ([xshift=-\boxLeftExtra]sH-1.west);

\node[obsbox,fit=(L0)(s0-m)] (box0) {};
\node[obsbox,fit=(L1)(s1-m)] (box1) {};
\node[obsbox,fit=(Lh)(sh-m)] (boxh) {};
\node[obsbox,fit=(LHm)(sHm-m)] (boxHm) {};
\node[obsbox,fit=(LH)(sH-m)] (boxH) {};

% Labels INSIDE boxes
\def\labx{2.5mm}
\def\laby{-3.2mm}
\def\labyy{-1mm}
\node[anchor=north west] at ([xshift=\labx,yshift=\laby]box0.north west) {$D_0$};
\node[anchor=north west] at ([xshift=\labx,yshift=\laby]box1.north west) {$D_1$};
\node[anchor=north west] at ([xshift=\labx,yshift=\laby]boxh.north west) {$D_h$};
\node[anchor=north west] at ([xshift=\labx,yshift=\laby]boxHm.north west) {$D_{H-2}$};
\node[anchor=north west] at ([xshift=\labx,yshift=\labyy]boxH.north west) {$D_{H-1}$};

% Reward notes INSIDE boxes
\node[anchor=north west,align=left] at ([xshift=\labx,yshift=-8.2mm]box0.north west)
  { $r_0=0$};
\node[anchor=north west,align=left] at ([xshift=\labx,yshift=-8.2mm]box1.north west)
  { $r_1=0$};
\node[anchor=north west,align=left] at ([xshift=\labx,yshift=-8.2mm]boxh.north west)
  { $r_h=0$};
\node[anchor=north west,align=left] at ([xshift=\labx,yshift=-8.2mm]boxHm.north west)
  { $r_{H-2}=0$};

\node[anchor=north west,align=left] at ([xshift=\labx,yshift=-4.5mm]boxH.north west)
  { $r_{H-1}\in\{\pm1\}$\\[1.0mm] $\E[r_{H-1}]=r_\infty$};

% -------------------------
% Transitions
% -------------------------
% a2 edges (vertical, observed chain)
\foreach \u/\v in {s0-1/s1-1,s0-2/s1-2,s0-3/s1-3,s0-m/s1-m,
                  s1-1/sh-1,s1-2/sh-2,s1-3/sh-3,s1-m/sh-m,
                  sh-1/sHm-1,sh-2/sHm-2,sh-3/sHm-3,sh-m/sHm-m,
                  sHm-1/sH-1,sHm-2/sH-2,sHm-3/sH-3,sHm-m/sH-m} {
  \draw[atwo] (\u) -- (\v);
}

% a1 edges (to aggregator at next layer)
\foreach \u/\v in {s0-1/g1,s0-2/g1,s0-3/g1,s0-m/g1,
                  s1-1/gh,s1-2/gh,s1-3/gh,s1-m/gh,
                  sh-1/gHm,sh-2/gHm,sh-3/gHm,sh-m/gHm,
                  sHm-1/gH,sHm-2/gH,sHm-3/gH,sHm-m/gH} {
  \draw[aone] (\u) -- (\v);
}

% aggregator chain: show BOTH actions with slight separation
\foreach \u/\v in {g0/g1,g1/gh,gh/gHm,gHm/gH} {
  \draw[aone] (\u) to[bend left=10] (\v);
  \draw[atwo] (\u) to[bend right=10] (\v);
}

% dots
\node at (\xAgg,{(\yRowMid+\yRowHm)/2}) {$\vdots$};
\node at (\xOne,{(\yRowMid+\yRowHm)/2}) {$\vdots$};

\end{scope}
\end{tikzpicture}
% Requires in preamble:
% \usetikzlibrary{arrows.meta,fit,positioning}

